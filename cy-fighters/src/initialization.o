#ifndef INITIALIZATION_C
#define INITIALIZATION_C

#include <stdio.h>
#include "../include/settings.h"


Fighters inisialization_fighter(char *nom, char *description, int pv_max, int attaque, int defense, int agilite, int vitesse) {
    Fighters fighter;

    strcpy(fighter.nom, nom);
    strcpy(fighter.description, description);
    fighter.pv_max = pv_max;
    fighter.pv_courant = pv_max;
    fighter.attaque = attaque;
    fighter.defense = defense;
    fighter.agilite = agilite;
    fighter.vitesse = vitesse;
    fighter.nb_skills = 0;
    fighter.nb_effects = 0;

    return fighter;
}

Skills inisialization_skill(char *nom, char *description, int coefficient, int tours_actifs, int tours_recharge) {
    Skills skill;

    strcpy(skill.nom, nom);
    strcpy(skill.description, description);
    skill.coefficient = coefficient; 
    skill.tours_actifs = tours_actifs; 
    skill.tours_recharge = tours_recharge; 

    return skill;
}

void fighters(Fighters fighters[]) {
    char source[MAX_CARATERES] = "data/fighters.txt";
    FILE *fp = fopen(source, "r");
    if (fp == NULL) {
        fprintf(stderr, "Erreur lors de l'ouverture du fichier %s\n", source);
        exit(2);
    }
    char line[MAX_FILES];
    int index = 0;
    
    while(fgets(line, sizeof(line), fp)){
        if (strncmp(line, "Nom;", 4) == 0) {
            
            char nom[MAX_CARATERES];
            char description[MAX_CARATERES];
            int pv_max;
            int attaque;
            int defense;
            int agilite;
            int vitesse;
            
            sscanf(line, "Nom; %[^\n]", nom);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Description; %[^\n]", description);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Point de vie max; %d", &pv_max);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Attaque; %d", &attaque);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Defense; %d", &defense);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Agilite; %d", &agilite);
            fgets(line, sizeof(line), fp);

            sscanf(line, "Vitesse; %d", &vitesse);
            fgets(line, sizeof(line), fp);

            fighters[index] = inisialization_fighter(nom, description, pv_max, attaque, defense, agilite, vitesse);
            index++;

            if (index >= MAX_MEMBRES) {
                break; // Éviter de dépasser la limite des combattants
            }

        }
    }
    fclose(fp);
}

void skills(Fighters fighters[]) {
    char source[MAX_CARATERES] = "data/skills.txt";
    FILE *file = fopen(source, "r");
    if (file == NULL) {
        fprintf(stderr, "Erreur lors de l'ouverture du fichier %s\n", source);
        exit(3);
    }
    char line[MAX_FILES];
    int index = 0;

    while (fgets(line, sizeof(line), file)) {
        if (strncmp(line, "Nom;", 4) == 0) {
            char nom[MAX_CARATERES];
            char description[MAX_CARATERES];
            int coefficient;
            int tours_actifs;
            int tours_recharge;

            sscanf(line, "Nom; %[^\n]", nom);
            fgets(line, sizeof(line), file);

            sscanf(line, "Description; %[^\n]", description);
            fgets(line, sizeof(line), file);

            sscanf(line, "Coefficient; %d", &coefficient);
            fgets(line, sizeof(line), file);

            sscanf(line, "Tours actifs; %d", &tours_actifs);
            fgets(line, sizeof(line), file);

            sscanf(line, "Tours recharge; %d", &tours_recharge);
            fgets(line, sizeof(line), file);

            fighters[index].skills[fighters[index].nb_skills] = inisialization_skill(nom, description, coefficient, tours_actifs, tours_recharge);
            fighters[index].nb_skills++;

            if (fighters[index].nb_skills >= MAX_SKILLS) {
                break;
            }
        }
    }
    fclose(file);
}

void inisialization(Fighters entity[]) {
    
    fighters(entity); 
    skills(entity);  
 
}

#endif 