#ifndef LOGIC_H
#define LOGIC_H

#include "../data/initialisation.h"

/*
    Inclusion indirecte de characters.h.
    characters.h : contient la structure des personnages leurs compétences et les equipes.
 */

 void inisialitation_fighters(Fighters fighters[]) {
    /*
        
    */

    fighters[0] = init_fighter("Le Sans-eclat", "Un guerrier errant, porteur d'un destin incertain, mais d'une volonte inebranlable", 8, 7, 7, 6, 6);
    fighters[1] = init_fighter("Malenia", "Une epeiste legendaire, incarnation de la grace et de la mort, redoutable mais fragile", 6, 9, 5, 10, 8);
    fighters[2] = init_fighter("Godfrey", "Un guerrier imposant, incarnation de la force brute et de la determination", 10, 9, 8, 5, 4);
    fighters[3] = init_fighter("Ranni", "Une sorciere enigmatique, gardienne des secrets des astres et des ombres", 5, 10, 4, 7, 5);
    fighters[4] = init_fighter("Mohg", "Un prince maudit, maitre des flammes sanglantes et des rituels interdits", 9, 8, 6, 6, 5);
    fighters[5] = init_fighter("Morgott", "Un roi maudit, dernier rempart d'un royaume dechire par la decadence", 7, 8, 8, 5, 6);
}

void inisialitation_skills(Fighters fighters[]) {

    // Competences du Sans-eclat
    fighters[0].skills[0] = init_skill("Coup du vagabond", "Une attaque equilibree, reflet de sa quete solitaire", 40, 1, 2);
    fighters[0].skills[1] = init_skill("Determination", "Une volonte inebranlable qui renforce temporairement l'attaque", 0, 2, 3);
    fighters[0].skills[2] = init_skill("Riposte", "Une contre-attaque precise et decisive", 50, 1, 2);
    fighters[0].nb_skills = 3;

    // Competences de Malenia
    fighters[1].skills[0] = init_skill("Danse de lames", "Une serie d'attaques gracieuses et mortelles", 60, 1, 4);
    fighters[1].skills[1] = init_skill("Regeneration", "Une force mystique qui restaure des points de vie apres chaque attaque", 0, 3, 5);
    fighters[1].skills[2] = init_skill("Lame ecarlate", "Une frappe sanglante qui inflige des degats et applique un saignement", 50, 2, 4);
    fighters[1].nb_skills = 3;

    // Competences de Godfrey
    fighters[2].skills[0] = init_skill("Frappe colossale", "Une attaque devastatrice qui ebranle les ennemis", 70, 1, 3);
    fighters[2].skills[1] = init_skill("Rugissement bestial", "Un cri puissant qui affaiblit les ennemis proches", 0, 2, 4);
    fighters[2].skills[2] = init_skill("Ecrasement terrestre", "Une attaque de zone qui inflige des degats massifs", 80, 1, 5);
    fighters[2].nb_skills = 3;

    // Competences de Ranni
    fighters[3].skills[0] = init_skill("Etoile glaciale", "Une attaque magique qui inflige des degats et ralentit l'ennemi", 50, 1, 3);
    fighters[3].skills[1] = init_skill("Invocation spectrale", "Invoque un allie temporaire", 0, 3, 5);
    fighters[3].skills[2] = init_skill("Pluie d'etoiles", "Une attaque magique de zone", 60, 1, 4);
    fighters[3].nb_skills = 3;

    // Competences de Mohg
    fighters[4].skills[0] = init_skill("Flammes sanglantes", "Une attaque qui inflige des degats et applique un saignement", 60, 1, 3);
    fighters[4].skills[1] = init_skill("Rituel interdit", "Inflige des degats massifs a tous les ennemis au prix de ses propres PV", 90, 1, 5);
    fighters[4].skills[2] = init_skill("Marque du sang", "Affaiblit l'ennemi et reduit sa defense", 0, 2, 4);
    fighters[4].nb_skills = 3;

    // Competences de Morgott
    fighters[5].skills[0] = init_skill("Lame sacree", "Inflige des degats sacres", 70, 1, 3);
    fighters[5].skills[1] = init_skill("Pluie de lames", "Une serie d'attaques rapides", 50, 1, 4);
    fighters[5].skills[2] = init_skill("Jugement divin", "Inflige des degats massifs a tous les ennemis", 90, 1, 5);
    fighters[5].nb_skills = 3;
}

int show_fighters(Fighters fighters[],  int nb_fighter) {
    /*
        Affiche les personnages disponibles pour le joueur.
        Renvoie le nombre de personnages disponibles.
    */
    printf(" \n");
    for (int i = 0; i < nb_fighter; i++) {
        printf("> %s - %s\n", fighters[i].nom, fighters[i].description);

        printf("\n  Statistique :\n");
        printf("  +  Point de vie : %d/%d\n  Attaque : %d\n  Defense : %d\n  Agilite : %d\n  Vitesse : %d\n", 
            fighters[i].pv_courant, 
            fighters[i].pv_max , 
            fighters[i].attaque, 
            fighters[i].defense, 
            fighters[i].agilite, 
            fighters[i].vitesse);

        printf("\n  Competences :\n");
        for(int j = 0; j < fighters[i].nb_skills; j++) { // Affichage des compétences
            printf("  + %s : %s\n   Valeur : %d\n   Tours actifs : %d\n   Tours recharge : %d\n",
                   fighters[i].skills[j].nom,
                   fighters[i].skills[j].description,
                   fighters[i].skills[j].coefficient,
                   fighters[i].skills[j].tours_actifs,
                   fighters[i].skills[j].tours_recharge);
        }

        printf("\n");
    }
    return nb_fighter;
}

int select_fighter(Fighters fighters[], int nb_fighters) {
    /*
    Sélectionne un personnage parmi les personnages disponibles.
    Renvoie l'index du personnage sélectionné.
    */
    int choix = -1; // Initialisation de choix à une valeur invalide

    while (1) { // Boucle infinie pour gérer les entrées invalides
        printf("Choisissez votre personnage (0-%d) : ", nb_fighters - 1);
        if (scanf("%d", &choix) == 1 && choix >= 0 && choix < nb_fighters) {
            break;
        } else {
            printf("Choix invalide. Veuillez entrer un nombre entre 0 et %d.\n", nb_fighters - 1);
            while (getchar() != '\n'); // Nettoyer le buffer d'entrée
        }
    }

    printf("Vous avez choisi %s !\n", fighters[choix].nom);
    return choix; // Retourne l'index du personnage sélectionné
}

void select_team(Fighters fighters[], int nb_fighters, Teams *team) {
    /*
        Permet au joueur de sélectionner une équipe de 3 personnages parmi les 6 disponibles.
    */
    printf("--- Selection de l'equipe ---\n");
    printf("Entrez le nom de votre equipe : ");
    char tmp[MAX_CARATERES]; // Variable temporaire pour la lecture du nom de l'équipe
    scanf("%s", tmp);
    int n = strlen(tmp); // Longueur du nom de l'équipe
    if (n > MAX_CARATERES) { // Vérification de la longueur du nom
        printf("Le nom de l'equipe est trop long. Il doit faire moins de %d caracteres.\n", MAX_CARATERES);
        exit(1); // Sortie du programme si le nom est trop long
    }
     // Lecture du nom de l'équipe
    (*team).nom = malloc(sizeof(char) * n); // Allocation de mémoire pour le nom de l'équipe
    scanf("%s", (*team)); // Lecture du nom de l'équipe
    

    int selected_indices[MAX_MEMBRES] = {-1, -1, -1}; // Stocke les indices des personnages sélectionnés
    for (int i = 0; i < MAX_MEMBRES; i++) {
        printf("\nChoisissez le personnage %d/%d pour votre equipe :\n", i + 1, MAX_MEMBRES);
        int fighter_index = select_fighter(fighters, nb_fighters);

        // Vérifier si le personnage est déjà sélectionné
        int selected = 0;
        for (int j = 0; j < i; j++) {
            if (selected_indices[j] == fighter_index) {
                selected = 1;
                break;
            }
        }

        if (selected == 1) {
            printf("Ce personnage est deja dans votre equipe. Veuillez en choisir un autre.\n");
            i--; // Refaire la sélection pour ce tour
        } else {
            selected_indices[i] = fighter_index;
            (*team).fighters[i] = fighters[fighter_index]; // Ajouter le personnage à l'équipe
            (*team).nb_membres++; // Incrémenter le nombre de membres de l'équipe
            printf("%s a ete ajoute à votre equipe.\n", fighters[fighter_index].nom);
        }
    }

    printf("\nVotre equipe est prete :\n");
    for (int i = 0; i < MAX_MEMBRES; i++) {
        printf("- %s\n", (*team).fighters[i].nom);
    }
}

int select_skill(Fighters fighters[], int fighter_index) {
    /*
        Sélectionne une compétence parmi les compétences du personnage sélectionné.
        Renvoie l'index de la compétence sélectionnée.
    */
    int choix = -1; // Initialisation de choix à une valeur invalide

    while (1) { // Boucle infinie pour gérer les entrées invalides
        printf("Choisissez votre competence (0-%d) : ", fighters[fighter_index].nb_skills - 1);
        if (scanf("%d", &choix) == 1 && choix >= 0 && choix < fighters[fighter_index].nb_skills) {
            break;
        } else {
            printf("Choix invalide. Veuillez entrer un nombre entre 0 et %d.\n", fighters[fighter_index].nb_skills - 1);
            while (getchar() != '\n'); // Nettoyer le buffer d'entrée
        }
    }

    printf("Vous avez choisi la competence %s !\n", fighters[fighter_index].skills[choix].nom);
    return choix; // Retourne l'index de la compétence sélectionnée
}

void attack_target(Fighters *attacker, Fighters *target, int skill_index) {
    /*
        Effectue une attaque d'un personnage sur un autre.
        Calcule les dégâts infligés en fonction de l'attaque et de la défense.
    */
    int degats = (*attacker).skills[skill_index].coefficient - (*target).defense; // Calcul des dégâts
    if (degats < 0) {
        degats = 0; // Les dégâts ne peuvent pas être négatifs
    }
    (*target).pv_courant -= degats; // Réduction des points de vie de la cible
    printf("%s attaque %s avec %s et inflige %d degats !\n", (*attacker).nom, (*target).nom, (*attacker).skills[skill_index].nom, degats);
}

void effect_target(Fighters fighters[], int fighter_index, int effect_index) {

    // Effets du Sans-eclat
    if (strcmp(fighters[fighter_index].nom, "Le Sans-eclat") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Determination") == 0) {
            fighters[effect_index].attaque += fighters[fighter_index].skills[0].coefficient; // Augmente l'attaque
            printf("%s utilise %s et augmente son attaque de %d !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Riposte") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[1].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Effets de Malenia
    if (strcmp(fighters[fighter_index].nom, "Malenia") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Regeneration") == 0) {
            fighters[effect_index].pv_courant += fighters[fighter_index].skills[0].coefficient; // Restaure des PV
            printf("%s utilise %s et restaure %d PV !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Lame ecarlate") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[1].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Effets de Godfrey
    if (strcmp(fighters[fighter_index].nom, "Godfrey") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Rugissement bestial") == 0) {
            fighters[effect_index].defense -= fighters[fighter_index].skills[0].coefficient; // Réduit la défense de la cible
            printf("%s utilise %s et reduit la defense de %d !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Ecrasement terrestre") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[1].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Effets de Ranni
    if (strcmp(fighters[fighter_index].nom, "Ranni") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Invocation spectrale") == 0) {
            fighters[effect_index].pv_courant += fighters[fighter_index].skills[0].coefficient; // Restaure des PV
            printf("%s utilise %s et restaure %d PV !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Pluie d'etoiles") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[1].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Effets de Mohg
    if (strcmp(fighters[fighter_index].nom, "Mohg") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Rituel interdit") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[0].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Marque du sang") == 0) {
            fighters[effect_index].defense -= fighters[fighter_index].skills[1].coefficient; // Réduit la défense de la cible
            printf("%s utilise %s et reduit la defense de %d !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Effets de Morgott
    if (strcmp(fighters[fighter_index].nom, "Morgott") == 0) {
        if (strcmp(fighters[effect_index].skills[0].nom, "Pluie de lames") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[0].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[0].nom, fighters[fighter_index].skills[0].coefficient);
        } else if (strcmp(fighters[effect_index].skills[1].nom, "Jugement divin") == 0) {
            fighters[effect_index].pv_courant -= fighters[fighter_index].skills[1].coefficient; // Réduit les PV de la cible
            printf("%s utilise %s et inflige %d degats !\n", fighters[fighter_index].nom, fighters[effect_index].skills[1].nom, fighters[fighter_index].skills[1].coefficient);
        }
    }

    // Vérification des PV de la cible
    if (fighters[effect_index].pv_courant <= 0) {
        printf("%s a ete vaincu !\n", fighters[effect_index].nom);
        fighters[effect_index].pv_courant = 0; // Réinitialisation des PV de la cible
    } else {
        printf("%s a encore %d PV restants.\n", fighters[effect_index].nom, fighters[effect_index].pv_courant);
    }

}

int load(Fighters fighters[], Teams player_team, Teams enemy_team) {
    /*
        Fonction de chargement du jeu.
        Initialise les personnages et les équipes, 
        affiche les personnages disponibles, 
        et permet au joueur de sélectionner un personnage.
    */
    int nb_fighters = show_fighters(fighters, MAX_FIGHTERS); // Affichage des personnages disponibles
    select_team(fighters, nb_fighters, &player_team); // Sélection de l'équipe du joueur
    select_team(fighters, nb_fighters, &enemy_team); // Sélection de l'équipe de l'ennemi

    return 0; // Retourne 0 pour indiquer que le chargement s'est bien passé
}
    
void start() {
    /*

    */
    Fighters fighters[MAX_FIGHTERS]; 
    Teams player_team; 
    Teams enemy_team; 
    
    
    inisialitation_fighters(fighters); 
    inisialitation_skills(fighters);  

    load(fighters, player_team, enemy_team); 
 
}



#endif